<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DIU Campus Schedule Admin Dashboard</title>
    
    <!-- Firebase SDK -->
    <script defer src="/__/firebase/12.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=false"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2em;
            font-weight: 700;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .stat-card h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .card {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .file-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: #667eea;
        }
        .file-input:hover {
            border-color: #5a67d8;
            background: #f0f4ff;
        }
        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        .routine-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .routine-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .routine-info h4 {
            color: #4a5568;
            margin-bottom: 5px;
        }
        .routine-info p {
            color: #718096;
            font-size: 0.9em;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üéì DIU Routine Admin Dashboard</h1>
            <div class="user-info">
                <span id="userDisplay">üë§ Admin User</span>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä Total Routines</h3>
                <div class="stat-value" id="totalRoutines">-</div>
            </div>
            <div class="stat-card">
                <h3>üìÖ Last Updated</h3>
                <div class="stat-value" style="font-size: 1.2em;" id="lastUpdated">-</div>
            </div>
            <div class="stat-card">
                <h3>üìÖ Effective From</h3>
                <div class="stat-value" style="font-size: 1.2em;" id="effectiveFrom">-</div>
            </div>
            <div class="stat-card">
                <h3>üéì Semester</h3>
                <div class="stat-value" style="font-size: 1.2em;" id="semester">-</div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <h2>üì§ Upload New Routine</h2>
            <div class="form-group">
                <label for="routineFile">Select Routine JSON File</label>
                <div class="file-input-wrapper">
                    <div class="file-input">
                        <input type="file" id="routineFile" accept=".json" onchange="handleFileSelect(this)">
                        üìÅ Click to select routine.json file or drag & drop
                    </div>
                </div>
            </div>
            <div id="fileInfo" class="hidden" style="margin: 10px 0; padding: 10px; background: #e6f3ff; border-radius: 5px;">
                <strong>Selected:</strong> <span id="fileName"></span><br>
                <strong>Size:</strong> <span id="fileSize"></span>
            </div>
            <button class="btn" onclick="uploadRoutine()" id="uploadBtn">
                üì§ Upload Routine
            </button>
            <div id="uploadStatus" class="status"></div>
        </div>

        <!-- Current Routines -->
        <div class="card">
            <h2>üìã Current Routines</h2>
            <button class="btn" onclick="listRoutines()">üîÑ Refresh List</button>
            <div id="routineList" class="routine-list">
                <p>Click "Refresh List" to load routines...</p>
            </div>
        </div>

        <!-- Maintenance Control -->
        <div class="card">
            <h2>üîß Maintenance Control</h2>
            <p>Manage maintenance mode for routine updates and semester transitions.</p>
            <button class="btn" onclick="enableMaintenanceMode()">üîß Enable Maintenance Mode</button>
            <button class="btn" onclick="disableMaintenanceMode()">‚úÖ Disable Maintenance Mode</button>
            <button class="btn btn-danger" onclick="setSemesterBreak()">üèñÔ∏è Set Semester Break</button>
            <button class="btn" onclick="clearMaintenanceData()" style="background: #6c757d;">üßπ Clear All Maintenance Data</button>
            <div id="maintenanceStatus" class="status"></div>
        </div>

        <!-- Version Management -->
        <div class="card">
            <h2>üîÑ Version Management</h2>
            <p>Update the routine version to notify all app users about new data.</p>
            <button class="btn" onclick="updateVersion()">üì¢ Trigger User Updates</button>
            <button class="btn btn-danger" onclick="deleteAllRoutines()">üóëÔ∏è Delete All Routines</button>
            <div id="versionStatus" class="status"></div>
        </div>
    </div>

    <script>
        let db;
        let selectedFile = null;

        // Check authentication
        function checkAuth() {
            const session = localStorage.getItem('adminSession');
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            
            if (!session || isLoggedIn !== 'true') {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const sessionData = JSON.parse(session);
                if (!sessionData.authenticated) {
                    window.location.href = '/login.html';
                    return false;
                }
                
                // Update user display
                document.getElementById('userDisplay').textContent = `üë§ ${sessionData.username}`;
                return true;
            } catch (e) {
                localStorage.removeItem('adminSession');
                sessionStorage.removeItem('isLoggedIn');
                window.location.href = '/login.html';
                return false;
            }
        }

        // Initialize Firebase and check auth
        document.addEventListener("DOMContentLoaded", function() {
            if (!checkAuth()) return;
            
            console.log("Dashboard loaded, waiting for Firebase...");
            
            // Wait for Firebase to load
            const checkFirebase = setInterval(() => {
                if (typeof firebase !== "undefined" && firebase.firestore) {
                    console.log("Firebase loaded successfully");
                    db = firebase.firestore();
                    
                    // Test Firebase connection
                    console.log("Testing Firebase connection...");
                    db.collection('test').limit(1).get()
                        .then(() => {
                            console.log("Firebase connection successful");
                            loadDashboardData();
                        })
                        .catch((error) => {
                            console.error("Firebase connection failed:", error);
                            showStatus('uploadStatus', `‚ùå Firebase connection failed: ${error.message}`, true);
                        });
                    
                    clearInterval(checkFirebase);
                } else {
                    console.log("Still waiting for Firebase...");
                }
            }, 100);
        });

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('adminSession');
                sessionStorage.removeItem('isLoggedIn');
                window.location.href = '/login.html';
            }
        }

        function showStatus(elementId, message, isError = false) {
            const statusEl = document.getElementById(elementId);
            statusEl.className = `status ${isError ? "error" : "success"}`;
            statusEl.innerHTML = message;
            statusEl.style.display = "block";
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileInfo').classList.remove('hidden');
                
                // Update file input display
                const fileInputDiv = input.parentElement;
                fileInputDiv.innerHTML = `
                    <input type="file" id="routineFile" accept=".json" onchange="handleFileSelect(this)">
                    ‚úÖ ${file.name} selected
                `;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadRoutine() {
            if (!selectedFile) {
                showStatus('uploadStatus', '‚ùå Please select a JSON file first', true);
                return;
            }

            if (!selectedFile.name.endsWith('.json')) {
                showStatus('uploadStatus', '‚ùå Please select a valid JSON file', true);
                return;
            }

            try {
                document.getElementById('uploadBtn').disabled = true;
                showStatus('uploadStatus', 'üì§ Reading file...', false);

                const fileContent = await readFileContent(selectedFile);
                const routineData = JSON.parse(fileContent);

                showStatus('uploadStatus', 'üîÑ Uploading to Firebase...', false);

                // Extract metadata from routine data
                const effectiveFrom = routineData.effectiveFrom || null;
                const semester = routineData.semester || null;
                const department = routineData.department || null;
                
                // Debug: Log extracted data
                console.log("Extracted data from JSON:");
                console.log("effectiveFrom:", effectiveFrom);
                console.log("semester:", semester);
                console.log("department:", department);
                console.log("Full routine data keys:", Object.keys(routineData));

                // Upload to Firestore
                const docRef = await db.collection('routines').add({
                    data: routineData,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'admin',
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    version: Date.now(),
                    effectiveFrom: effectiveFrom,
                    semester: semester,
                    department: department
                });

                // Update version metadata and clear maintenance mode
                await db.collection('metadata').doc('routine_version').set({
                    version: Date.now(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'admin',
                    effectiveFrom: effectiveFrom,
                    semester: semester,
                    department: department,
                    maintenanceMode: false,
                    maintenanceMessage: null,
                    updateType: 'routine_uploaded'
                }, { merge: true });

                showStatus('uploadStatus', 
                    `‚úÖ Routine uploaded successfully!<br>üìÑ Document ID: ${docRef.id}<br>üìÖ ${new Date().toLocaleString()}`, 
                    false
                );

                // Reset file input
                selectedFile = null;
                document.getElementById('fileInfo').classList.add('hidden');
                document.querySelector('.file-input').innerHTML = `
                    <input type="file" id="routineFile" accept=".json" onchange="handleFileSelect(this)">
                    üìÅ Click to select routine.json file or drag & drop
                `;

                // Refresh data
                loadDashboardData();
                listRoutines();

            } catch (error) {
                console.error('Upload error:', error);
                showStatus('uploadStatus', `‚ùå Upload failed: ${error.message}`, true);
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        async function listRoutines() {
            try {
                console.log("Listing routines...");
                const querySnapshot = await db.collection('routines').orderBy('uploadedAt', 'desc').get();
                const routineListDiv = document.getElementById('routineList');
                
                console.log(`Found ${querySnapshot.size} routines to display`);
                
                if (querySnapshot.empty) {
                    console.log("No routines found");
                    routineListDiv.innerHTML = '<p>No routines found. Upload your first routine above!</p>';
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const uploadedAt = data.uploadedAt ? data.uploadedAt.toDate().toLocaleString() : 'Unknown';
                    
                    // Try to get metadata from document or from nested data
                    let effectiveFrom = data.effectiveFrom || 'Not specified';
                    let semester = data.semester || 'Unknown';
                    let department = data.department || 'Unknown';
                    
                    // If not found at document level, try to extract from nested data
                    if (data.data && (effectiveFrom === 'Not specified' || semester === 'Unknown' || department === 'Unknown')) {
                        effectiveFrom = data.data.effectiveFrom || effectiveFrom;
                        semester = data.data.semester || semester;
                        department = data.data.department || department;
                    }
                    
                    console.log(`Routine ${doc.id}:`, {
                        effectiveFrom, semester, department,
                        hasNestedData: !!data.data,
                        nestedKeys: data.data ? Object.keys(data.data) : []
                    });
                    
                    html += `
                        <div class="routine-item">
                            <div class="routine-info">
                                <h4>üìÑ ${data.fileName || 'routine.json'}</h4>
                                <p>üìÖ Uploaded: ${uploadedAt}</p>
                                <p>üóìÔ∏è Effective From: ${effectiveFrom}</p>
                                <p>üéì Semester: ${semester}</p>
                                <p>üè¢ Department: ${department}</p>
                                <p>üì¶ Size: ${formatFileSize(data.fileSize || 0)}</p>
                                <p>üÜî ID: ${doc.id}</p>
                            </div>
                            <button class="btn btn-danger" onclick="deleteRoutine('${doc.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `;
                });

                routineListDiv.innerHTML = html;

            } catch (error) {
                console.error('Error listing routines:', error);
                document.getElementById('routineList').innerHTML = `<p style="color: red;">‚ùå Error loading routines: ${error.message}</p>`;
            }
        }

        async function deleteRoutine(docId) {
            if (confirm('Are you sure you want to delete this routine?')) {
                try {
                    // Delete the routine document
                    await db.collection('routines').doc(docId).delete();
                    
                    // Update version metadata to notify apps about the deletion
                    await db.collection('metadata').doc('routine_version').set({
                        version: Date.now(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: 'admin',
                        updateType: 'routine_deleted',
                        deletedRoutineId: docId,
                        maintenanceMode: true,
                        maintenanceMessage: 'Routine is being updated. New schedule will be available soon.'
                    }, { merge: true });
                    
                    showStatus('versionStatus', '‚úÖ Routine deleted successfully! Apps will be notified of the update.', false);
                    listRoutines();
                    loadDashboardData();
                } catch (error) {
                    showStatus('versionStatus', `‚ùå Delete failed: ${error.message}`, true);
                }
            }
        }

        async function updateVersion() {
            try {
                await db.collection('metadata').doc('routine_version').set({
                    version: Date.now(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: 'admin',
                    updateType: 'manual_trigger'
                }, { merge: true });

                showStatus('versionStatus', '‚úÖ Version updated! All app users will be notified.', false);
                loadDashboardData();

            } catch (error) {
                console.error('Error updating version:', error);
                showStatus('versionStatus', `‚ùå Version update failed: ${error.message}`, true);
            }
        }

        async function deleteAllRoutines() {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete ALL routines? This action cannot be undone!')) {
                if (confirm('üö® FINAL WARNING: This will permanently delete all routine data!')) {
                    try {
                        const querySnapshot = await db.collection('routines').get();
                        const batch = db.batch();
                        
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        
                        // Update version metadata to notify apps about the bulk deletion
                        await db.collection('metadata').doc('routine_version').set({
                            version: Date.now(),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: 'admin',
                            updateType: 'all_routines_deleted',
                            deletedCount: querySnapshot.size,
                            maintenanceMode: true,
                            maintenanceMessage: 'System maintenance in progress. New routines will be uploaded soon.'
                        }, { merge: true });
                        
                        showStatus('versionStatus', '‚úÖ All routines deleted successfully! Apps will be notified of the update.', false);
                        listRoutines();
                        loadDashboardData();

                    } catch (error) {
                        console.error('Error deleting routines:', error);
                        showStatus('versionStatus', `‚ùå Delete failed: ${error.message}`, true);
                    }
                }
            }
        }

        async function enableMaintenanceMode() {
            const message = prompt('Enter maintenance message for users:', 'System maintenance in progress. New routines will be uploaded soon.');
            if (message) {
                try {
                    await db.collection('metadata').doc('routine_version').set({
                        version: Date.now(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: 'admin',
                        updateType: 'maintenance_enabled',
                        maintenanceMode: true,
                        maintenanceMessage: message,
                        semesterBreak: false // Regular maintenance, not semester break
                    }, { merge: true });
                    
                    showStatus('maintenanceStatus', '‚úÖ Maintenance mode enabled! Apps will show maintenance message.', false);
                } catch (error) {
                    showStatus('maintenanceStatus', `‚ùå Failed to enable maintenance mode: ${error.message}`, true);
                }
            }
        }

        async function disableMaintenanceMode() {
            try {
                await db.collection('metadata').doc('routine_version').set({
                    version: Date.now(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: 'admin',
                    updateType: 'maintenance_disabled',
                    maintenanceMode: false,
                    maintenanceMessage: null,
                    semesterBreak: false // Explicitly clear semester break when disabling maintenance
                }, { merge: true });
                
                showStatus('maintenanceStatus', '‚úÖ Maintenance mode disabled! Apps will return to normal.', false);
            } catch (error) {
                showStatus('maintenanceStatus', `‚ùå Failed to disable maintenance mode: ${error.message}`, true);
            }
        }

        async function setSemesterBreak() {
            const message = prompt('Enter semester break message:', 'Semester break is in progress. New semester routine will be available soon.');
            if (message) {
                try {
                    await db.collection('metadata').doc('routine_version').set({
                        version: Date.now(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: 'admin',
                        updateType: 'semester_break',
                        maintenanceMode: true,
                        maintenanceMessage: message,
                        semesterBreak: true
                    }, { merge: true });
                    
                    showStatus('maintenanceStatus', '‚úÖ Semester break mode enabled! Apps will show break message.', false);
                } catch (error) {
                    showStatus('maintenanceStatus', `‚ùå Failed to set semester break: ${error.message}`, true);
                }
            }
        }

        async function clearMaintenanceData() {
            if (confirm('This will clear all maintenance settings and return the app to normal. Continue?')) {
                try {
                    await db.collection('metadata').doc('routine_version').set({
                        version: Date.now(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: 'admin',
                        updateType: 'maintenance_cleared',
                        maintenanceMode: false,
                        maintenanceMessage: null,
                        semesterBreak: false
                    }, { merge: true });
                    
                    showStatus('maintenanceStatus', '‚úÖ All maintenance data cleared! Apps will return to normal.', false);
                } catch (error) {
                    showStatus('maintenanceStatus', `‚ùå Failed to clear maintenance data: ${error.message}`, true);
                }
            }
        }

        async function loadDashboardData() {
            try {
                console.log("Loading dashboard data...");
                
                // Load routine count
                console.log("Fetching routines collection...");
                const routinesSnapshot = await db.collection('routines').get();
                console.log(`Found ${routinesSnapshot.size} routines`);
                document.getElementById('totalRoutines').textContent = routinesSnapshot.size;

                // Load version info
                console.log("Fetching version metadata...");
                const versionDoc = await db.collection('metadata').doc('routine_version').get();
                if (versionDoc.exists) {
                    const versionData = versionDoc.data();
                    console.log("Version data:", versionData);
                    
                    // Try to get effectiveFrom and semester from version data or from latest routine
                    let effectiveFromDate = versionData.effectiveFrom;
                    let semesterInfo = versionData.semester;
                    
                    if ((!effectiveFromDate || !semesterInfo) && routinesSnapshot.size > 0) {
                        // Try to get from latest routine
                        console.log("Missing data in metadata, checking latest routine...");
                        const latestRoutineSnapshot = await db.collection('routines').orderBy('uploadedAt', 'desc').limit(1).get();
                        if (!latestRoutineSnapshot.empty) {
                            const latestData = latestRoutineSnapshot.docs[0].data();
                            if (!effectiveFromDate) {
                                effectiveFromDate = latestData.effectiveFrom || (latestData.data ? latestData.data.effectiveFrom : null);
                                console.log("Found effectiveFrom in latest routine:", effectiveFromDate);
                            }
                            if (!semesterInfo) {
                                semesterInfo = latestData.semester || (latestData.data ? latestData.data.semester : null);
                                console.log("Found semester in latest routine:", semesterInfo);
                            }
                        }
                    }
                    
                    // Display effective from date
                    if (effectiveFromDate) {
                        console.log("Setting effectiveFrom:", effectiveFromDate);
                        document.getElementById('effectiveFrom').textContent = effectiveFromDate;
                    } else {
                        console.log("No effectiveFrom found anywhere");
                        document.getElementById('effectiveFrom').textContent = "Not set";
                    }
                    
                    // Display semester info
                    if (semesterInfo) {
                        console.log("Setting semester:", semesterInfo);
                        document.getElementById('semester').textContent = semesterInfo;
                    } else {
                        console.log("No semester found anywhere");
                        document.getElementById('semester').textContent = "Not set";
                    }
                    
                    if (versionData.lastUpdated) {
                        const lastUpdatedDate = versionData.lastUpdated.toDate().toLocaleDateString();
                        console.log("Setting lastUpdated:", lastUpdatedDate);
                        document.getElementById('lastUpdated').textContent = lastUpdatedDate;
                    }
                } else {
                    console.log("No version metadata found");
                    document.getElementById('effectiveFrom').textContent = "Not available";
                    document.getElementById('lastUpdated').textContent = "Not available";
                    document.getElementById('semester').textContent = "Not available";
                }

                // Semester is handled above with other metadata

                console.log("Dashboard data loaded successfully");

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showStatus('uploadStatus', `‚ùå Error loading data: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>