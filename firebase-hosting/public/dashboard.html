<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DIU Campus Schedule Admin Dashboard</title>
    
    <!-- Firebase SDK -->
    <script defer src="/__/firebase/12.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=false"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2em;
            font-weight: 700;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .stat-card h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .card {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .file-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: #667eea;
        }
        .file-input:hover {
            border-color: #5a67d8;
            background: #f0f4ff;
        }
        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        #systemStatus div {
            padding: 3px 0;
            font-size: 0.9em;
            font-weight: 500;
        }
        .status-normal { color: #22543d; }
        .status-maintenance { color: #d69e2e; }
        .status-break { color: #3182ce; }
        .status-cleared { color: #e53e3e; }
        .status-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
        }
        .status-close:hover {
            opacity: 1;
        }
        .routine-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .routine-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .routine-info h4 {
            color: #4a5568;
            margin-bottom: 5px;
        }
        .routine-info p {
            color: #718096;
            font-size: 0.9em;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
        
        /* Modern Message Input Styles */
        .message-input-group {
            margin-bottom: 25px;
        }
        
        .modern-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 1em;
        }
        
        .label-icon {
            font-size: 1.2em;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .modern-textarea {
            width: 100%;
            min-height: 80px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
            background: #ffffff;
            color: #2d3748;
        }
        
        .modern-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #f8f9ff;
        }
        
        .modern-textarea::placeholder {
            color: #a0aec0;
        }
        
        .char-counter {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 11px;
            color: #a0aec0;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            backdrop-filter: blur(4px);
        }
        
        /* Modal Popup Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8) translateY(50px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            transition: all 0.3s ease;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: #f7fafc;
            color: #4a5568;
            transform: rotate(90deg);
        }
        
        .modal-textarea {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
            background: #f8f9ff;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .modal-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            background: #ffffff;
        }
        
        .modal-textarea::placeholder {
            color: #a0aec0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .modal-char-counter {
            font-size: 14px;
            color: #a0aec0;
            font-weight: 500;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .modal-btn.cancel {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        
        .modal-btn.cancel:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        
        .modal-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-btn.confirm:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .modal-btn.confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 25px;
        }
        
        .modern-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            min-height: 50px;
        }
        
        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .modern-btn:active {
            transform: translateY(0);
        }
        
        .modern-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modern-btn.primary:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .modern-btn.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .modern-btn.success:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }
        
        .modern-btn.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .modern-btn.warning:hover {
            box-shadow: 0 8px 25px rgba(237, 137, 54, 0.4);
        }
        
        .modern-btn.secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
        }
        
        .modern-btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(113, 128, 150, 0.4);
        }
        
        .btn-icon {
            font-size: 1.1em;
        }
        
        .btn-text {
            font-weight: 600;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .modern-btn {
                min-height: 45px;
                font-size: 13px;
                padding: 12px 16px;
            }
            
            .modern-textarea {
                min-height: 70px;
                padding: 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üéì DIU Routine Admin Dashboard</h1>
            <div class="user-info">
                <span id="userDisplay">üë§ Admin User</span>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä Total Routines</h3>
                <div class="stat-value" id="totalRoutines">-</div>
            </div>
            <div class="stat-card">
                <h3>üìÖ Last Updated</h3>
                <div class="stat-value" style="font-size: 1.2em;" id="lastUpdated">-</div>
            </div>
            <div class="stat-card">
                <h3>üìÖ Effective From</h3>
                <div class="stat-value" style="font-size: 1.2em;" id="effectiveFrom">-</div>
            </div>
            <div class="stat-card">
                <h3>üéì Semester</h3>
                <div class="stat-value" style="font-size: 1.2em;" id="semester">-</div>
            </div>
            <div class="stat-card">
                <h3>üîß System Status</h3>
                <div class="stat-value" style="font-size: 1.0em;" id="systemStatus">
                    <div id="maintenanceStatus">üü¢ Normal Operation</div>
                    <div id="semesterBreakStatus" style="margin-top: 5px;">üìö Academic Period</div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <h2>üì§ Upload New Routine</h2>
            <div class="form-group">
                <label for="routineFile">Select Routine JSON File</label>
                <div class="file-input-wrapper">
                    <div class="file-input">
                        <input type="file" id="routineFile" accept=".json" onchange="handleFileSelect(this)">
                        üìÅ Click to select routine.json file or drag & drop
                    </div>
                </div>
            </div>
            <div id="fileInfo" class="hidden" style="margin: 10px 0; padding: 10px; background: #e6f3ff; border-radius: 5px;">
                <strong>Selected:</strong> <span id="fileName"></span><br>
                <strong>Size:</strong> <span id="fileSize"></span>
            </div>
            <button class="btn" onclick="uploadRoutine()" id="uploadBtn">
                üì§ Upload Routine
            </button>
            <div id="uploadStatus" class="status"></div>
        </div>

        <!-- Current Routines -->
        <div class="card">
            <h2>üìã Current Routines</h2>
            <button class="btn" onclick="listRoutines()">üîÑ Refresh List</button>
            <div id="routineList" class="routine-list">
                <p>Click "Refresh List" to load routines...</p>
            </div>
        </div>

        <!-- Maintenance Control -->
        <div class="card">
            <h2>üîß Maintenance Control</h2>
            <p>Manage maintenance mode for routine updates and semester transitions. Push notifications will be sent to all users.</p>
            
            <!-- Action Buttons -->
            <div class="button-grid">
                <button class="modern-btn primary" onclick="openMaintenanceModal()">
                    <span class="btn-icon">üîß</span>
                    <span class="btn-text">Enable Maintenance</span>
                </button>
                <button class="modern-btn success" onclick="disableMaintenanceMode()">
                    <span class="btn-icon">‚úÖ</span>
                    <span class="btn-text">Disable Maintenance</span>
                </button>
                <button class="modern-btn warning" onclick="openSemesterBreakModal()">
                    <span class="btn-icon">üèñÔ∏è</span>
                    <span class="btn-text">Set Semester Break</span>
                </button>
                <button class="modern-btn secondary" onclick="clearMaintenanceData()">
                    <span class="btn-icon">üßπ</span>
                    <span class="btn-text">Clear All Data</span>
                </button>
            </div>
            
            <div id="maintenanceStatus" class="status"></div>
        </div>

        <!-- Message Input Modal -->
        <div id="messageModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <span id="modalIcon">üîß</span>
                        <span id="modalTitle">Maintenance Message</span>
                    </div>
                    <button class="modal-close" onclick="closeMessageModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <textarea 
                        id="modalTextarea" 
                        class="modal-textarea"
                        placeholder="Enter your message here..."
                        maxlength="500"
                    ></textarea>
                    
                    <div class="modal-footer">
                        <div class="modal-char-counter">
                            <span id="modalCharCount">0</span>/500 characters
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn cancel" onclick="closeMessageModal()">
                                <span>‚ùå</span>
                                Cancel
                            </button>
                            <button class="modal-btn confirm" id="modalConfirmBtn" onclick="confirmMessage()">
                                <span>‚úÖ</span>
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Version Management -->
        <div class="card">
            <h2>üîÑ Version Management</h2>
            <p>Send push notifications to all app users about updates and changes.</p>
            <button class="btn" onclick="triggerManualUpdate()">üì¢ Send Update Notifications</button>
            <button class="btn btn-danger" onclick="deleteAllRoutines()">üóëÔ∏è Delete All Routines</button>
            <div id="versionStatus" class="status"></div>
        </div>

        <!-- Debug Section -->
        <div class="card">
            <h2>üêõ Debug Information</h2>
            <p>Check FCM token registration and notification system status.</p>
            <button class="btn" onclick="checkFCMTokens()">üîç Check FCM Tokens</button>
            <button class="btn" onclick="getSystemStats()">üìä Get System Stats</button>
            <button class="btn" onclick="testStatus()" style="background: red; color: white;">üß™ TEST STATUS</button>
            <div id="debugStatus" class="status"></div>
        </div>
    </div>

    <script>
        let db;
        let selectedFile = null;

        // Check authentication
        function checkAuth() {
            const session = localStorage.getItem('adminSession');
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            
            if (!session || isLoggedIn !== 'true') {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const sessionData = JSON.parse(session);
                if (!sessionData.authenticated) {
                    window.location.href = '/login.html';
                    return false;
                }
                
                // Update user display
                document.getElementById('userDisplay').textContent = `üë§ ${sessionData.username}`;
                return true;
            } catch (e) {
                localStorage.removeItem('adminSession');
                sessionStorage.removeItem('isLoggedIn');
                window.location.href = '/login.html';
                return false;
            }
        }

        // Initialize Firebase and check auth
        document.addEventListener("DOMContentLoaded", function() {
            if (!checkAuth()) return;
            
            console.log("Dashboard loaded, waiting for Firebase...");
            
            // Wait for Firebase to load
            const checkFirebase = setInterval(() => {
                if (typeof firebase !== "undefined" && firebase.firestore && firebase.functions) {
                    console.log("Firebase loaded successfully");
                    db = firebase.firestore();
                    
                    // Test Firebase connection
                    console.log("Testing Firebase connection...");
                    db.collection('test').limit(1).get()
                        .then(() => {
                            console.log("Firebase connection successful");
                            
                            // Test Functions connection
                            console.log("Testing Firebase Functions...");
                            const testFunc = firebase.functions().httpsCallable('getSystemStats');
                            testFunc().then(() => {
                                console.log("Firebase Functions connection successful");
                                loadDashboardData();
                                loadSystemStatus(); // Load saved system status
                            }).catch((error) => {
                                console.error("Firebase Functions test failed:", error);
                                // Still load dashboard even if functions test fails
                                loadDashboardData();
                                loadSystemStatus(); // Load saved system status
                            });
                        })
                        .catch((error) => {
                            console.error("Firebase connection failed:", error);
                            showStatus('uploadStatus', `‚ùå Firebase connection failed: ${error.message}`, true);
                        });
                    
                    clearInterval(checkFirebase);
                } else {
                    console.log("Still waiting for Firebase... firestore:", !!firebase?.firestore, "functions:", !!firebase?.functions);
                }
            }, 100);
        });

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('adminSession');
                sessionStorage.removeItem('isLoggedIn');
                window.location.href = '/login.html';
            }
        }

        // Test function using the fixed showStatus
        function testStatus() {
            showStatus('debugStatus', '‚úÖ Status system is now working perfectly! All dashboard functions will show feedback.', false);
        }

        // Function to update system status display
        function updateSystemStatus(maintenanceMode = null, semesterBreak = null, dataCleared = null) {
            const maintenanceEl = document.getElementById('maintenanceStatus');
            const semesterEl = document.getElementById('semesterBreakStatus');
            
            // Update maintenance status
            if (maintenanceMode !== null) {
                if (maintenanceMode) {
                    maintenanceEl.innerHTML = 'üî¥ Maintenance Mode';
                    maintenanceEl.className = 'status-maintenance';
                    localStorage.setItem('lastMaintenanceAction', 'enabled');
                } else {
                    maintenanceEl.innerHTML = 'üü¢ Normal Operation';
                    maintenanceEl.className = 'status-normal';
                    localStorage.setItem('lastMaintenanceAction', 'disabled');
                }
            }
            
            // Update semester break status
            if (semesterBreak !== null) {
                if (semesterBreak) {
                    semesterEl.innerHTML = 'üèñÔ∏è Semester Break';
                    semesterEl.className = 'status-break';
                    localStorage.setItem('lastSemesterAction', 'break_enabled');
                } else {
                    semesterEl.innerHTML = 'üìö Academic Period';
                    semesterEl.className = 'status-normal';
                    localStorage.setItem('lastSemesterAction', 'break_disabled');
                }
            }
            
            // Update data cleared status
            if (dataCleared === true) {
                semesterEl.innerHTML = 'üóëÔ∏è Data Cleared';
                semesterEl.className = 'status-cleared';
                localStorage.setItem('lastSemesterAction', 'data_cleared');
            }
        }

        // Function to load saved status on page load
        function loadSystemStatus() {
            const lastMaintenance = localStorage.getItem('lastMaintenanceAction');
            const lastSemester = localStorage.getItem('lastSemesterAction');
            
            if (lastMaintenance === 'enabled') {
                updateSystemStatus(true, null, null);
            } else if (lastMaintenance === 'disabled') {
                updateSystemStatus(false, null, null);
            }
            
            if (lastSemester === 'break_enabled') {
                updateSystemStatus(null, true, null);
            } else if (lastSemester === 'break_disabled') {
                updateSystemStatus(null, false, null);
            } else if (lastSemester === 'data_cleared') {
                updateSystemStatus(null, null, true);
            }
        }

        function showStatus(elementId, message, isError = false) {
            // Remove any existing status message
            const existingStatus = document.getElementById('DYNAMIC_STATUS_MESSAGE');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // Create a new status element (same approach as working test)
            const statusDiv = document.createElement('div');
            statusDiv.id = 'DYNAMIC_STATUS_MESSAGE';
            statusDiv.innerHTML = message;
            
            // Use working CSS approach
            const bgColor = isError ? '#fed7d7' : '#c6f6d5';
            const textColor = isError ? '#742a2a' : '#22543d';
            const borderColor = isError ? '#f56565' : '#48bb78';
            
            statusDiv.style.cssText = `
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                background: ${bgColor} !important;
                color: ${textColor} !important;
                padding: 15px 20px !important;
                border-left: 4px solid ${borderColor} !important;
                border-radius: 8px !important;
                font-size: 14px !important;
                z-index: 999999 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                max-width: 400px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            `;
            
            // Add to body (guaranteed to be visible)
            document.body.appendChild(statusDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (statusDiv && statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 5000);
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileInfo').classList.remove('hidden');
                
                // Update file input display
                const fileInputDiv = input.parentElement;
                fileInputDiv.innerHTML = `
                    <input type="file" id="routineFile" accept=".json" onchange="handleFileSelect(this)">
                    ‚úÖ ${file.name} selected
                `;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadRoutine() {
            if (!selectedFile) {
                showStatus('uploadStatus', '‚ùå Please select a JSON file first', true);
                return;
            }

            if (!selectedFile.name.endsWith('.json')) {
                showStatus('uploadStatus', '‚ùå Please select a valid JSON file', true);
                return;
            }

            try {
                document.getElementById('uploadBtn').disabled = true;
                showStatus('uploadStatus', 'üì§ Reading file...', false);

                const fileContent = await readFileContent(selectedFile);
                const routineData = JSON.parse(fileContent);

                showStatus('uploadStatus', 'üîÑ Uploading to Firebase...', false);

                // Extract metadata from routine data
                const effectiveFrom = routineData.effectiveFrom || null;
                const semester = routineData.semester || null;
                const department = routineData.department || null;
                
                // Debug: Log extracted data
                console.log("Extracted data from JSON:");
                console.log("effectiveFrom:", effectiveFrom);
                console.log("semester:", semester);
                console.log("department:", department);
                console.log("Full routine data keys:", Object.keys(routineData));

                // Upload to Firestore
                const docRef = await db.collection('routines').add({
                    data: routineData,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'admin',
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    version: Date.now(),
                    effectiveFrom: effectiveFrom,
                    semester: semester,
                    department: department
                });

                // Update version metadata and clear maintenance mode
                await db.collection('metadata').doc('routine_version').set({
                    version: Date.now(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedBy: 'admin',
                    effectiveFrom: effectiveFrom,
                    semester: semester,
                    department: department,
                    maintenanceMode: false,
                    maintenanceMessage: null,
                    updateType: 'routine_uploaded'
                }, { merge: true });

                showStatus('uploadStatus', 
                    `‚úÖ Routine uploaded successfully!<br>üìÑ Document ID: ${docRef.id}<br>üìÖ ${new Date().toLocaleString()}`, 
                    false
                );

                // Reset file input
                selectedFile = null;
                document.getElementById('fileInfo').classList.add('hidden');
                document.querySelector('.file-input').innerHTML = `
                    <input type="file" id="routineFile" accept=".json" onchange="handleFileSelect(this)">
                    üìÅ Click to select routine.json file or drag & drop
                `;

                // Refresh data
                loadDashboardData();
                listRoutines();

            } catch (error) {
                console.error('Upload error:', error);
                showStatus('uploadStatus', `‚ùå Upload failed: ${error.message}`, true);
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        async function listRoutines() {
            try {
                console.log("Listing routines...");
                const querySnapshot = await db.collection('routines').orderBy('uploadedAt', 'desc').get();
                const routineListDiv = document.getElementById('routineList');
                
                console.log(`Found ${querySnapshot.size} routines to display`);
                
                if (querySnapshot.empty) {
                    console.log("No routines found");
                    routineListDiv.innerHTML = '<p>No routines found. Upload your first routine above!</p>';
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const uploadedAt = data.uploadedAt ? data.uploadedAt.toDate().toLocaleString() : 'Unknown';
                    
                    // Try to get metadata from document or from nested data
                    let effectiveFrom = data.effectiveFrom || 'Not specified';
                    let semester = data.semester || 'Unknown';
                    let department = data.department || 'Unknown';
                    
                    // If not found at document level, try to extract from nested data
                    if (data.data && (effectiveFrom === 'Not specified' || semester === 'Unknown' || department === 'Unknown')) {
                        effectiveFrom = data.data.effectiveFrom || effectiveFrom;
                        semester = data.data.semester || semester;
                        department = data.data.department || department;
                    }
                    
                    console.log(`Routine ${doc.id}:`, {
                        effectiveFrom, semester, department,
                        hasNestedData: !!data.data,
                        nestedKeys: data.data ? Object.keys(data.data) : []
                    });
                    
                    html += `
                        <div class="routine-item">
                            <div class="routine-info">
                                <h4>üìÑ ${data.fileName || 'routine.json'}</h4>
                                <p>üìÖ Uploaded: ${uploadedAt}</p>
                                <p>üóìÔ∏è Effective From: ${effectiveFrom}</p>
                                <p>üéì Semester: ${semester}</p>
                                <p>üè¢ Department: ${department}</p>
                                <p>üì¶ Size: ${formatFileSize(data.fileSize || 0)}</p>
                                <p>üÜî ID: ${doc.id}</p>
                            </div>
                            <button class="btn btn-danger" onclick="deleteRoutine('${doc.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `;
                });

                routineListDiv.innerHTML = html;

            } catch (error) {
                console.error('Error listing routines:', error);
                document.getElementById('routineList').innerHTML = `<p style="color: red;">‚ùå Error loading routines: ${error.message}</p>`;
            }
        }

        async function deleteRoutine(docId) {
            if (confirm('Are you sure you want to delete this routine?')) {
                try {
                    // Delete the routine document
                    await db.collection('routines').doc(docId).delete();
                    
                    // Update version metadata to notify apps about the deletion
                    await db.collection('metadata').doc('routine_version').set({
                        version: Date.now(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: 'admin',
                        updateType: 'routine_deleted',
                        deletedRoutineId: docId,
                        maintenanceMode: true,
                        maintenanceMessage: 'Routine is being updated. New schedule will be available soon.'
                    }, { merge: true });
                    
                    showStatus('versionStatus', '‚úÖ Routine deleted successfully! Apps will be notified of the update.', false);
                    listRoutines();
                    loadDashboardData();
                } catch (error) {
                    showStatus('versionStatus', `‚ùå Delete failed: ${error.message}`, true);
                }
            }
        }

        async function triggerManualUpdate() {
            try {
                showStatus('versionStatus', '‚è≥ Sending push notifications to all users...', false);
                
                // Call Cloud Function to send manual update notifications
                const triggerUpdate = firebase.functions().httpsCallable('triggerManualUpdate');
                const result = await triggerUpdate();

                showStatus('versionStatus', '‚úÖ Push notifications sent to all users!', false);
                loadDashboardData();

            } catch (error) {
                console.error('Error triggering manual update:', error);
                showStatus('versionStatus', `‚ùå Manual update failed: ${error.message}`, true);
            }
        }

        async function deleteAllRoutines() {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete ALL routines? This action cannot be undone!')) {
                if (confirm('üö® FINAL WARNING: This will permanently delete all routine data!')) {
                    try {
                        const querySnapshot = await db.collection('routines').get();
                        const batch = db.batch();
                        
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        
                        // Update version metadata to notify apps about the bulk deletion
                        await db.collection('metadata').doc('routine_version').set({
                            version: Date.now(),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: 'admin',
                            updateType: 'all_routines_deleted',
                            deletedCount: querySnapshot.size,
                            maintenanceMode: true,
                            maintenanceMessage: 'System maintenance in progress. New routines will be uploaded soon.'
                        }, { merge: true });
                        
                        showStatus('versionStatus', '‚úÖ All routines deleted successfully! Apps will be notified of the update.', false);
                        listRoutines();
                        loadDashboardData();

                    } catch (error) {
                        console.error('Error deleting routines:', error);
                        showStatus('versionStatus', `‚ùå Delete failed: ${error.message}`, true);
                    }
                }
            }
        }

        // Modal functionality
        let currentModalAction = null;
        
        function openMaintenanceModal() {
            currentModalAction = 'maintenance';
            document.getElementById('modalIcon').textContent = 'üîß';
            document.getElementById('modalTitle').textContent = 'Maintenance Message';
            document.getElementById('modalTextarea').placeholder = 'Enter maintenance message for users...';
            document.getElementById('modalTextarea').value = 'System maintenance in progress. New routines will be uploaded soon.';
            document.getElementById('modalConfirmBtn').innerHTML = '<span>üîß</span> Enable Maintenance';
            
            showModal();
        }
        
        function openSemesterBreakModal() {
            currentModalAction = 'semester';
            document.getElementById('modalIcon').textContent = 'üèñÔ∏è';
            document.getElementById('modalTitle').textContent = 'Semester Break Message';
            document.getElementById('modalTextarea').placeholder = 'Enter semester break message for users...';
            document.getElementById('modalTextarea').value = 'Semester break is in progress. New semester routine will be available soon.';
            document.getElementById('modalConfirmBtn').innerHTML = '<span>üèñÔ∏è</span> Set Semester Break';
            
            showModal();
        }
        
        function showModal() {
            const modal = document.getElementById('messageModal');
            const textarea = document.getElementById('modalTextarea');
            
            modal.classList.add('show');
            updateModalCharCount();
            
            // Focus on textarea after animation
            setTimeout(() => {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }, 300);
            
            // Close modal on escape key
            document.addEventListener('keydown', handleEscapeKey);
        }
        
        function closeMessageModal() {
            const modal = document.getElementById('messageModal');
            modal.classList.remove('show');
            currentModalAction = null;
            
            // Remove escape key listener
            document.removeEventListener('keydown', handleEscapeKey);
        }
        
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeMessageModal();
            }
        }
        
        function updateModalCharCount() {
            const textarea = document.getElementById('modalTextarea');
            const counter = document.getElementById('modalCharCount');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const currentLength = textarea.value.length;
            
            counter.textContent = currentLength;
            
            // Color coding based on length
            if (currentLength > 450) {
                counter.style.color = '#e53e3e';
            } else if (currentLength > 350) {
                counter.style.color = '#ed8936';
            } else {
                counter.style.color = '#4a5568';
            }
            
            // Enable/disable confirm button
            confirmBtn.disabled = currentLength === 0;
        }
        
        async function confirmMessage() {
            const message = document.getElementById('modalTextarea').value.trim();
            
            if (!message) {
                showStatus('maintenanceStatus', '‚ùå Please enter a message before confirming.', true);
                return;
            }
            
            // Call the function first, then close modal after it completes
            try {
                if (currentModalAction === 'maintenance') {
                    await enableMaintenanceMode(message);
                } else if (currentModalAction === 'semester') {
                    await setSemesterBreak(message);
                }
                
                // Close modal after function completes
                closeMessageModal();
            } catch (error) {
                console.error("Error in confirmMessage:", error);
                showStatus('maintenanceStatus', '‚ùå Operation failed. Please try again.', true);
                // Still close modal even if there's an error
                closeMessageModal();
            }
        }

        async function enableMaintenanceMode(message = null) {
            // Check if Firebase Functions is available
            if (typeof firebase === "undefined" || !firebase.functions) {
                console.error("Firebase Functions not available");
                showStatus('maintenanceStatus', '‚ùå Firebase Functions not loaded. Please refresh the page.', true);
                return;
            }
            
            // If no message provided, show error
            if (!message) {
                console.error("No message provided to enableMaintenanceMode");
                showStatus('maintenanceStatus', '‚ùå No message provided for maintenance mode.', true);
                return;
            }
            
            try {
                showStatus('maintenanceStatus', '‚è≥ Enabling maintenance mode and sending push notifications...', false);
                
                // Call Cloud Function to enable maintenance mode and send push notifications
                const enableMaintenance = firebase.functions().httpsCallable('enableMaintenanceMode');
                const result = await enableMaintenance({ message: message });
                
                showStatus('maintenanceStatus', '‚úÖ Maintenance mode enabled! Push notifications sent to all users.', false);
                updateSystemStatus(true, null, null); // Update system status
                loadDashboardData();
            } catch (error) {
                console.error('Enable maintenance error:', error);
                showStatus('maintenanceStatus', `‚ùå Failed to enable maintenance mode: ${error.message || error.code || 'Unknown error'}`, true);
            }
        }

        async function disableMaintenanceMode() {
            try {
                showStatus('maintenanceStatus', '‚è≥ Disabling maintenance mode and sending push notifications...', false);
                
                // Call Cloud Function to disable maintenance mode and send push notifications
                const disableMaintenance = firebase.functions().httpsCallable('disableMaintenanceMode');
                const result = await disableMaintenance();
                
                showStatus('maintenanceStatus', '‚úÖ Maintenance mode disabled! Push notifications sent to all users.', false);
                updateSystemStatus(false, null, null); // Update system status
                loadDashboardData();
            } catch (error) {
                console.error('Disable maintenance error:', error);
                showStatus('maintenanceStatus', `‚ùå Failed to disable maintenance mode: ${error.message}`, true);
            }
        }

        async function setSemesterBreak(message = null) {
            // If no message provided, it came from modal
            if (!message) {
                return; // This should not happen with the modal system
            }
            
            try {
                await db.collection('metadata').doc('routine_version').set({
                    version: Date.now(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: 'admin',
                    updateType: 'semester_break',
                    maintenanceMode: true,
                    maintenanceMessage: message,
                    semesterBreak: true
                }, { merge: true });
                
                showStatus('maintenanceStatus', '‚úÖ Semester break mode enabled! Apps will show break message.', false);
                updateSystemStatus(null, true, null); // Update system status
            } catch (error) {
                showStatus('maintenanceStatus', `‚ùå Failed to set semester break: ${error.message}`, true);
            }
        }

        async function clearMaintenanceData() {
            if (confirm('This will clear all maintenance settings and return the app to normal. Continue?')) {
                try {
                    showStatus('maintenanceStatus', '‚è≥ Clearing maintenance data...', false);
                    
                    // Call Cloud Function to clear maintenance data
                    const clearMaintenance = firebase.functions().httpsCallable('clearMaintenanceData');
                    const result = await clearMaintenance();
                    
                    showStatus('maintenanceStatus', '‚úÖ All maintenance data cleared! Apps will return to normal.', false);
                    updateSystemStatus(null, null, true); // Update system status to show data cleared
                    loadDashboardData();
                } catch (error) {
                    console.error('Clear maintenance error:', error);
                    showStatus('maintenanceStatus', `‚ùå Failed to clear maintenance data: ${error.message}`, true);
                }
            }
        }

        async function loadDashboardData() {
            try {
                console.log("Loading dashboard data...");
                
                // Load routine count
                console.log("Fetching routines collection...");
                const routinesSnapshot = await db.collection('routines').get();
                console.log(`Found ${routinesSnapshot.size} routines`);
                document.getElementById('totalRoutines').textContent = routinesSnapshot.size;

                // Load version info
                console.log("Fetching version metadata...");
                const versionDoc = await db.collection('metadata').doc('routine_version').get();
                if (versionDoc.exists) {
                    const versionData = versionDoc.data();
                    console.log("Version data:", versionData);
                    
                    // Try to get effectiveFrom and semester from version data or from latest routine
                    let effectiveFromDate = versionData.effectiveFrom;
                    let semesterInfo = versionData.semester;
                    
                    if ((!effectiveFromDate || !semesterInfo) && routinesSnapshot.size > 0) {
                        // Try to get from latest routine
                        console.log("Missing data in metadata, checking latest routine...");
                        const latestRoutineSnapshot = await db.collection('routines').orderBy('uploadedAt', 'desc').limit(1).get();
                        if (!latestRoutineSnapshot.empty) {
                            const latestData = latestRoutineSnapshot.docs[0].data();
                            if (!effectiveFromDate) {
                                effectiveFromDate = latestData.effectiveFrom || (latestData.data ? latestData.data.effectiveFrom : null);
                                console.log("Found effectiveFrom in latest routine:", effectiveFromDate);
                            }
                            if (!semesterInfo) {
                                semesterInfo = latestData.semester || (latestData.data ? latestData.data.semester : null);
                                console.log("Found semester in latest routine:", semesterInfo);
                            }
                        }
                    }
                    
                    // Display effective from date
                    if (effectiveFromDate) {
                        console.log("Setting effectiveFrom:", effectiveFromDate);
                        document.getElementById('effectiveFrom').textContent = effectiveFromDate;
                    } else {
                        console.log("No effectiveFrom found anywhere");
                        document.getElementById('effectiveFrom').textContent = "Not set";
                    }
                    
                    // Display semester info
                    if (semesterInfo) {
                        console.log("Setting semester:", semesterInfo);
                        document.getElementById('semester').textContent = semesterInfo;
                    } else {
                        console.log("No semester found anywhere");
                        document.getElementById('semester').textContent = "Not set";
                    }
                    
                    if (versionData.lastUpdated) {
                        const lastUpdatedDate = versionData.lastUpdated.toDate().toLocaleDateString();
                        console.log("Setting lastUpdated:", lastUpdatedDate);
                        document.getElementById('lastUpdated').textContent = lastUpdatedDate;
                    }
                } else {
                    console.log("No version metadata found");
                    document.getElementById('effectiveFrom').textContent = "Not available";
                    document.getElementById('lastUpdated').textContent = "Not available";
                    document.getElementById('semester').textContent = "Not available";
                }

                // Semester is handled above with other metadata

                console.log("Dashboard data loaded successfully");

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showStatus('uploadStatus', `‚ùå Error loading data: ${error.message}`, true);
            }
        }

        // Debug functions
        async function checkFCMTokens() {
            console.log("checkFCMTokens called");
            try {
                showStatus('debugStatus', '‚è≥ Checking FCM tokens...', false);
                console.log("Status shown: Checking FCM tokens");
                
                const fcmTokensSnapshot = await db.collection('fcm_tokens').get();
                console.log("FCM tokens query result:", fcmTokensSnapshot.size);
                
                if (fcmTokensSnapshot.empty) {
                    showStatus('debugStatus', '‚ùå No FCM tokens found in database! Android app needs to register tokens first.', true);
                    return;
                }
                
                let tokenDetails = `‚úÖ Found ${fcmTokensSnapshot.size} FCM tokens:<br><br>`;
                
                fcmTokensSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    tokenDetails += `üì± User: ${data.userId || 'Unknown'}<br>`;
                    tokenDetails += `üè´ Department: ${data.department || 'Unknown'}<br>`;
                    tokenDetails += `üîë Token: ${data.token ? data.token.substring(0, 20) + '...' : 'None'}<br>`;
                    tokenDetails += `‚úÖ Enabled: ${data.enabled !== false ? 'Yes' : 'No'}<br>`;
                    tokenDetails += `‚è∞ Updated: ${data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleString() : 'Unknown'}<br><br>`;
                });
                
                console.log("Showing token details");
                showStatus('debugStatus', tokenDetails, false);
                
            } catch (error) {
                console.error('Error checking FCM tokens:', error);
                showStatus('debugStatus', `‚ùå Error checking FCM tokens: ${error.message}`, true);
            }
        }

        async function getSystemStats() {
            console.log("getSystemStats called");
            try {
                showStatus('debugStatus', '‚è≥ Getting system statistics...', false);
                console.log("Status shown: Getting system statistics");
                
                // Check if the function exists
                if (!firebase.functions) {
                    console.error("Firebase Functions not available");
                    showStatus('debugStatus', '‚ùå Firebase Functions not available!', true);
                    return;
                }
                
                console.log("Calling getSystemStats function");
                const getStats = firebase.functions().httpsCallable('getSystemStats');
                const result = await getStats();
                console.log("Function result:", result);
                
                if (!result || !result.data) {
                    console.error("No data returned");
                    showStatus('debugStatus', '‚ùå No data returned from getSystemStats function!', true);
                    return;
                }
                
                const stats = result.data;
                console.log("Stats data:", stats);
                let statsHtml = `üìä <strong>System Statistics:</strong><br><br>`;
                
                if (stats.users) {
                    statsHtml += `üë• <strong>Users:</strong> ${stats.users.total || 0}<br>`;
                }
                if (stats.routines) {
                    statsHtml += `üìö <strong>Routines:</strong> ${stats.routines.total || 0}<br>`;
                }
                if (stats.analytics) {
                    statsHtml += `üìà <strong>Analytics:</strong> ${stats.analytics.total || 0}<br>`;
                }
                if (stats.feedback) {
                    statsHtml += `üí¨ <strong>Feedback:</strong> ${stats.feedback.total || 0}<br><br>`;
                }
                
                if (stats.fcmTokens) {
                    statsHtml += `üì± <strong>FCM Tokens:</strong><br>`;
                    statsHtml += `&nbsp;&nbsp;üì± Total: ${stats.fcmTokens.total || 0}<br>`;
                    statsHtml += `&nbsp;&nbsp;‚úÖ Valid: ${stats.fcmTokens.validTokens || 0}<br><br>`;
                    
                    if (stats.fcmTokens.breakdown) {
                        statsHtml += `üè´ <strong>Tokens by Department:</strong><br>`;
                        Object.entries(stats.fcmTokens.breakdown).forEach(([dept, count]) => {
                            statsHtml += `&nbsp;&nbsp;${dept}: ${count.enabled || 0}/${count.total || 0} enabled<br>`;
                        });
                    }
                    
                    if (stats.fcmTokens.total === 0) {
                        statsHtml += `<br>‚ö†Ô∏è <strong>No FCM tokens found!</strong><br>`;
                        statsHtml += `The Android app needs to be installed and opened to register FCM tokens.`;
                    }
                } else {
                    statsHtml += `üì± <strong>FCM Tokens:</strong> No data available<br>`;
                }
                
                // If stats object is empty or minimal, show raw data
                if (Object.keys(stats).length === 0) {
                    statsHtml = `üìä <strong>System Statistics:</strong><br><br>‚ùå No statistics data available from server.`;
                }
                
                console.log("Showing stats HTML");
                showStatus('debugStatus', statsHtml, false);
                
            } catch (error) {
                console.error('Error getting system stats:', error);
                let errorMsg = `‚ùå Error getting system stats: ${error.message}`;
                
                if (error.code === 'functions/not-found') {
                    errorMsg += '<br><br>üîß The getSystemStats function is not deployed. Please deploy the Cloud Functions.';
                }
                
                showStatus('debugStatus', errorMsg, true);
            }
        }
        
        // Modern UI enhancements
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modal functionality
            initializeModal();
            
            // Add smooth animations to status messages
            initializeStatusAnimations();
        });
        
        function initializeModal() {
            const textarea = document.getElementById('modalTextarea');
            const modal = document.getElementById('messageModal');
            
            // Character counter for modal
            textarea.addEventListener('input', updateModalCharCount);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeMessageModal();
                }
            });
            
            // Auto-resize modal textarea
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.max(120, this.scrollHeight) + 'px';
            });
        }
        
        function initializeStatusAnimations() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const target = mutation.target;
                        if (target.classList.contains('status') && target.style.display !== 'none') {
                            // Add entrance animation
                            target.style.opacity = '0';
                            target.style.transform = 'translateY(-10px)';
                            setTimeout(() => {
                                target.style.transition = 'all 0.3s ease';
                                target.style.opacity = '1';
                                target.style.transform = 'translateY(0)';
                            }, 10);
                        }
                    }
                });
            });
            
            const statusElements = document.querySelectorAll('.status');
            statusElements.forEach(element => {
                observer.observe(element, { attributes: true });
            });
        }
        
        // Enhanced button feedback
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modern-btn')) {
                // Add ripple effect
                const btn = e.target;
                const ripple = document.createElement('span');
                const rect = btn.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple 0.6s ease-out;
                    pointer-events: none;
                `;
                
                btn.style.position = 'relative';
                btn.style.overflow = 'hidden';
                btn.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            }
        });
        
        // Add ripple animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(2);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>